name: FingerbankCorruptedDB
testcases:
- name: get_psono_secret
  steps:
  - type: exec
    script: "echo -n 66a77c6b13f30f7324276ccc532679c6800a3a38"
    #    script: "psonoci secret get {{.configurator.fingerbank_api_key.secret_id}} password"
    vars:
      fingerbank_api_key:
        from: result.systemout
    
- name: Backup the DB and configuration
  steps:

  - type: exec
    script: 'cp /usr/local/fingerbank/db/fingerbank_Upstream.db /usr/local/fingerbank/db/fingerbank_Upstream.db.fingerbank_corrupted_db_test_backup'

  - type: exec
    script: 'cp /usr/local/fingerbank/conf/fingerbank.conf /usr/local/fingerbank/conf/fingerbank.conf.fingerbank_corrupted_db_test_backup'

- name: Deleting the device table from the Fingerbank DB
  steps:

  - type: exec
    script: 'sqlite3 /usr/local/fingerbank/db/fingerbank_Upstream.db "drop table device;"'

  - type: exec
    script: 'chown fingerbank: /usr/local/fingerbank/db/fingerbank_Upstream.db'

- name: Configuring Fingerbank
  steps:

  - type: exec
    script: 'printf "[upstream]\napi_key={{.get_psono_secret.fingerbank_api_key}}\n" > /usr/local/fingerbank/conf/fingerbank.conf'

  - type: exec
    script: '/usr/local/pf/bin/pfcmd cache fingerbank clear'

  - type: exec
    script: 'systemctl restart packetfence-fingerbank-collector'

- name: Testing RADIUS MAB
  steps:

  - type: exec
    # TODO: change 192.168.3.37 with a variable
    script: 'cat /usr/local/pf/t/venom/test_suites/fingerbank_invalid_db/mab.txt | radclient 192.168.3.37 auth `cat /usr/local/pf/conf/local_secret`'

- name: Teardown
  steps:
  - type: exec
    script: 'mv /usr/local/fingerbank/db/fingerbank_Upstream.db.fingerbank_corrupted_db_test_backup /usr/local/fingerbank/db/fingerbank_Upstream.db'

  - type: exec
    script: 'mv /usr/local/fingerbank/conf/fingerbank.conf.fingerbank_corrupted_db_test_backup /usr/local/fingerbank/conf/fingerbank.conf'

  - type: exec
    script: '/usr/local/pf/bin/pfcmd cache fingerbank clear'

  - type: exec
    script: 'systemctl restart packetfence-fingerbank-collector'

